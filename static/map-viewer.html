<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>湖北省地图浏览</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, 
                Segoe UI, Arial, Roboto, 'PingFang SC', 'miui', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
        }
        #map-container {
            height: calc(100% - 130px);
            width: 100%;
            background-color: #f3f3f3;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            height: 45px;
        }
        .tool-btn {
            width: 80px;
            height: 35px;
            line-height: 35px;
            font-size: 14px;
            border-radius: 5px;
            color: #2E8B57;
            border: 1px solid #2E8B57;
            background-color: #FFFFFF;
            text-align: center;
            cursor: pointer;
        }
        .tool-btn:disabled {
            color: #CCCCCC;
            border-color: #EEEEEE;
            background-color: #F8F8F8;
            cursor: not-allowed;
        }
        .map-title {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .map-counter {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666666;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .download-bar {
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            display: flex;
            justify-content: center;
            height: 40px;
            position: relative;
        }
        .download-btn {
            width: 100%;
            height: 40px;
            line-height: 40px;
            font-size: 15px;
            color: #FFFFFF;
            background-color: #2E8B57;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 130px);
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-text {
            font-size: 16px;
            color: #2E8B57;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            width: 80%;
            background-color: #FFFFFF;
            border-radius: 15px;
            padding: 20px 15px;
            max-width: 500px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-label {
            font-size: 15px;
            color: #666666;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            height: 40px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            height: 100px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .word-count {
            text-align: right;
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
        }
        .modal-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-btn {
            width: 45%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #F5F5F5;
            color: #666666;
        }
        .confirm-btn {
            background-color: #2E8B57;
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="map-container"></div>
    
    <!-- 加载指示器 -->
    <div id="loading" class="loading">
        <div class="loading-text" id="loading-text">地图加载中...</div>
    </div>
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button class="tool-btn" id="prevBtn" disabled>上一张</button>
        <div class="map-title" id="mapTitle">加载中...</div>
        <button class="tool-btn" id="nextBtn" disabled>下一张</button>
    </div>
    
    <!-- 下载栏 -->
    <div class="download-bar">
        <div class="map-counter" id="mapCounter">1 / 1</div>
        <div class="download-btn" id="downloadBtn">申请下载此图</div>
    </div>
    
    <!-- 下载对话框 -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">下载申请</div>
            <div class="form-item">
                <div class="form-label">邮箱地址</div>
                <input 
                    class="form-input" 
                    id="emailInput"
                    placeholder="请输入您的邮箱地址"
                    type="text"
                />
            </div>
            <div class="form-item">
                <div class="form-label">申请理由</div>
                <textarea 
                    class="form-textarea" 
                    id="reasonInput"
                    placeholder="请输入申请理由（50字以内）"
                    maxlength="50"
                ></textarea>
                <div class="word-count"><span id="wordCount">0</span>/50</div>
            </div>
            <div class="modal-btns">
                <div class="modal-btn cancel-btn" id="cancelBtn">取消</div>
                <div class="modal-btn confirm-btn" id="submitBtn">提交</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let viewer;
        let isViewerInitialized = false;
        let webViewData = null;
        let currentMapIndex = 0;
        let allMaps = [];
        let imageCache = new Map();
        
        // 解析URL参数
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            console.log('=== 解析URL参数 ===');
            
            let parsedData = null;
            if (dataParam) {
                try {
                    parsedData = JSON.parse(decodeURIComponent(dataParam));
                    console.log('解析成功，地图数量:', parsedData.allMaps?.length || 0);
                    console.log('当前地图:', parsedData.currentMap?.title);
                    console.log('当前索引:', parsedData.currentIndex);
                } catch (e) {
                    console.error('解析失败:', e);
                }
            }
            
            return parsedData;
        }
        
        // 生成地图URL（优化版，优先使用缓存）
        function generateOptimizedMapUrl(mapData) {
            if (!mapData || !mapData.id) {
                console.error('地图数据无效');
                return null;
            }
            
            console.log(`生成地图URL: ${mapData.title}`);
            
            // 检查本地缓存
            if (imageCache.has(mapData.id)) {
                const cached = imageCache.get(mapData.id);
                console.log(`使用本地缓存: ${mapData.title}`);
                return cached.url;
            }
            
            // 生成WMS URL
            const baseUrl = 'http://192.168.50.133:8080/geoserver/hubei/wms';
            const aspectRatio = (mapData.height && mapData.width) ? (mapData.height / mapData.width) : 0.724;
            const layers = `hubei:${mapData.id}`;
            
            const params = {
                SERVICE: 'WMS',
                VERSION: '1.1.1',
                REQUEST: 'GetMap',
                FORMAT: 'image/png',
                TRANSPARENT: 'true',
                LAYERS: layers,
                STYLES: '',
                SRS: 'EPSG:4326',
                BBOX: `0,0,1,${aspectRatio}`,
                WIDTH: mapData.width.toString(),
                HEIGHT: mapData.height.toString(),
                _t: Date.now()
            };
            
            const queryParts = [];
            for (const [key, value] of Object.entries(params)) {
                if (value !== null && value !== undefined) {
                    queryParts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                }
            }
            
            const fullUrl = `${baseUrl}?${queryParts.join('&')}`;
            console.log('生成WMS URL完成');
            
            return fullUrl;
        }
        
        // 预加载图片到本地缓存
        async function preloadToLocalCache(mapData) {
            if (imageCache.has(mapData.id)) {
                return imageCache.get(mapData.id);
            }
            
            console.log(`开始预加载到本地缓存: ${mapData.title}`);
            
            try {
                const mapUrl = generateOptimizedMapUrl(mapData);
                const response = await fetch(mapUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                
                const cached = {
                    url: objectUrl,
                    blob: blob,
                    timestamp: Date.now()
                };
                
                imageCache.set(mapData.id, cached);
                console.log(`本地缓存完成: ${mapData.title}`);
                
                return cached;
            } catch (error) {
                console.error(`预加载失败: ${mapData.title}`, error);
                return null;
            }
        }
        
        // 获取当前地图数据
        function getCurrentMapData() {
            return allMaps[currentMapIndex];
        }
        
        // 更新UI显示
        function updateUI() {
            const currentMap = getCurrentMapData();
            if (!currentMap) return;
            
            console.log(`更新UI: ${currentMap.title} (${currentMapIndex + 1}/${allMaps.length})`);
            
            // 更新标题
            document.getElementById('mapTitle').textContent = currentMap.title;
            
            // 更新计数器
            document.getElementById('mapCounter').textContent = `${currentMapIndex + 1} / ${allMaps.length}`;
            
            // 更新按钮状态
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentMapIndex === 0;
            nextBtn.disabled = currentMapIndex === allMaps.length - 1;
            
            console.log('UI更新完成');
        }
        
        // 加载当前地图
        async function loadCurrentMap() {
            const currentMap = getCurrentMapData();
            if (!currentMap) {
                console.error('当前地图数据无效');
                return;
            }
            
            console.log(`=== 加载地图: ${currentMap.title} ===`);
            
            const loadStartTime = Date.now();
            
            // 显示加载状态
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').textContent = '地图加载中...';
            
            // 更新UI
            updateUI();
            
            // 获取地图URL（优先使用缓存）
            let mapUrl;
            const cached = imageCache.get(currentMap.id);
            
            if (cached) {
                console.log('使用预加载缓存');
                mapUrl = cached.url;
            } else {
                console.log('生成新的地图URL');
                mapUrl = generateOptimizedMapUrl(currentMap);
            }
            
            if (!mapUrl) {
                console.error('无法获取地图URL');
                return;
            }
            
            // 加载到OpenSeadragon
            if (!isViewerInitialized) {
                console.log('初始化OpenSeadragon查看器');
                viewer = OpenSeadragon({
                    id: "map-container",
                    prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/images/",
                    tileSources: {
                        type: 'image',
                        url: mapUrl,
                        buildPyramid: false
                    },
                    immediateRender: false,
                    blendTime: 0.1,
                    showNavigator: false
                });
                
                isViewerInitialized = true;
                
                viewer.addHandler('open', function() {
                    const loadTime = Date.now() - loadStartTime;
                    console.log(`地图加载完成，耗时: ${loadTime}ms`);
                    document.getElementById('loading').style.display = 'none';
                });
                
            } else {
                console.log('切换到新地图');
                viewer.open({
                    type: 'image',
                    url: mapUrl,
                    buildPyramid: false
                });
                
                viewer.addOnceHandler('open', function() {
                    const loadTime = Date.now() - loadStartTime;
                    console.log(`地图切换完成，耗时: ${loadTime}ms`);
                    document.getElementById('loading').style.display = 'none';
                });
            }
            
            // 预加载相邻地图
            preloadAdjacentMaps();
        }
        
        // 预加载相邻地图
        async function preloadAdjacentMaps() {
            const adjacentIndexes = [];
            
            // 下一张
            if (currentMapIndex + 1 < allMaps.length) {
                adjacentIndexes.push(currentMapIndex + 1);
            }
            
            // 上一张
            if (currentMapIndex - 1 >= 0) {
                adjacentIndexes.push(currentMapIndex - 1);
            }
            
            console.log(`开始预加载相邻地图: ${adjacentIndexes.length}个`);
            
            // 异步预加载
            adjacentIndexes.forEach(index => {
                const mapData = allMaps[index];
                if (mapData && !imageCache.has(mapData.id)) {
                    preloadToLocalCache(mapData);
                }
            });
        }
        
        // 切换地图
        function switchMap(direction) {
            console.log(`=== 切换地图: ${direction} ===`);
            console.log(`当前索引: ${currentMapIndex}`);
            
            let newIndex = currentMapIndex;
            
            if (direction === 'next' && currentMapIndex < allMaps.length - 1) {
                newIndex = currentMapIndex + 1;
            } else if (direction === 'prev' && currentMapIndex > 0) {
                newIndex = currentMapIndex - 1;
            } else {
                console.log('无法切换到指定方向');
                return;
            }
            
            currentMapIndex = newIndex;
            
            console.log(`新索引: ${currentMapIndex}`);
            console.log(`新地图: ${getCurrentMapData().title}`);
            
            // 加载新地图
            loadCurrentMap();
        }
        
        // 显示下载对话框
        function showDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
            document.getElementById('emailInput').value = '';
            document.getElementById('reasonInput').value = '';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // 隐藏下载对话框
        function hideDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        // 提交下载申请
        function submitDownloadRequest() {
            const email = document.getElementById('emailInput').value.trim();
            const reason = document.getElementById('reasonInput').value.trim();
            
            if (!email || !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            if (!reason) {
                alert('请输入申请理由');
                return;
            }
            
            console.log('提交下载申请:', {
                mapId: getCurrentMapData().id,
                email: email,
                reason: reason
            });
            
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'downloadRequest',
                        email: email,
                        reason: reason,
                        mapId: getCurrentMapData().id
                    }
                });
            } catch (e) {
                console.log('向小程序发送消息失败:', e);
            }
            
            hideDownloadModal();
            alert('申请已提交，我们会尽快处理！');
        }
        
        // 查看详情
        function viewDetail() {
            console.log('查看详情:', getCurrentMapData().title);
            
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'viewDetail',
                        mapId: getCurrentMapData().id
                    }
                });
            } catch (e) {
                console.log('向小程序发送消息失败:', e);
            }
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 页面初始化 ===');
            
            // 解析数据
            webViewData = getUrlParams();
            
            if (!webViewData || !webViewData.allMaps || webViewData.allMaps.length === 0) {
                console.error('没有有效的地图数据');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loading-text').textContent = '无法加载地图数据';
                return;
            }
            
            // 初始化全局变量
            allMaps = webViewData.allMaps;
            currentMapIndex = webViewData.currentIndex || 0;
            
            console.log(`初始化完成 - 地图总数: ${allMaps.length}, 当前索引: ${currentMapIndex}`);
            
            // 加载初始地图
            loadCurrentMap();
            
            // 绑定事件
            document.getElementById('prevBtn').addEventListener('click', () => switchMap('prev'));
            document.getElementById('nextBtn').addEventListener('click', () => switchMap('next'));
            document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
            document.getElementById('cancelBtn').addEventListener('click', hideDownloadModal);
            document.getElementById('submitBtn').addEventListener('click', submitDownloadRequest);
            document.getElementById('map-container').addEventListener('dblclick', viewDetail);
            
            // 字数统计
            document.getElementById('reasonInput').addEventListener('input', function() {
                document.getElementById('wordCount').textContent = this.value.length;
            });
            
            console.log('事件绑定完成');
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            console.log('页面卸载，清理资源');
            
            // 清理图片缓存
            for (const [mapId, cached] of imageCache) {
                if (cached.url) {
                    URL.revokeObjectURL(cached.url);
                }
            }
            imageCache.clear();
        });
    </script>
</body>
</html>