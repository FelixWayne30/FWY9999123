<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>图幅浏览</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, 
                Segoe UI, Arial, Roboto, 'PingFang SC', 'miui', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
        }
        #map-container {
            height: calc(100% - 130px);
            width: 100%;
            background-color: #f3f3f3;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            height: 45px;
        }
        .tool-btn {
            width: 80px;
            height: 35px;
            line-height: 35px;
            font-size: 14px;
            border-radius: 5px;
            color: #2E8B57;
            border: 1px solid #2E8B57;
            background-color: #FFFFFF;
            text-align: center;
            cursor: pointer;
        }
        .tool-btn:disabled {
            color: #CCCCCC;
            border-color: #EEEEEE;
            background-color: #F8F8F8;
            cursor: not-allowed;
        }
        .map-title {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .map-counter {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666666;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .download-bar {
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            display: flex;
            justify-content: center;
            height: 40px;
            position: relative;
        }
        .download-btn {
            width: 100%;
            height: 40px;
            line-height: 40px;
            font-size: 15px;
            color: #FFFFFF;
            background-color: #2E8B57;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 130px);
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-text {
            font-size: 16px;
            color: #2E8B57;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .progress-container {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #2E8B57;
            width: 0%;
            transition: width 0.3s;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            width: 80%;
            background-color: #FFFFFF;
            border-radius: 15px;
            padding: 20px 15px;
            max-width: 500px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-label {
            font-size: 15px;
            color: #666666;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            height: 40px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            height: 100px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .word-count {
            text-align: right;
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
        }
        .modal-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-btn {
            width: 45%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #F5F5F5;
            color: #666666;
        }
        .confirm-btn {
            background-color: #2E8B57;
            color: #FFFFFF;
        }
        .status-bar {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            color: #666;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="map-container"></div>
    
    <!-- 加载指示器 -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="loading-text" id="loading-text">地图加载中...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>
    </div>
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button class="tool-btn" id="prevBtn" disabled>上一张</button>
        <div class="map-title" id="mapTitle">加载中...</div>
        <button class="tool-btn" id="nextBtn" disabled>下一张</button>
    </div>
    
    <!-- 下载栏 -->
    <div class="download-bar">
        <div class="map-counter" id="mapCounter">1 / 1</div>
        <div class="download-btn" id="downloadBtn">申请下载此图</div>
    </div>
    
    <!-- 缓存状态栏 -->
    <div class="status-bar" id="status-bar">缓存: 0/0</div>
    
    <!-- 下载对话框 -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">下载申请</div>
            <div class="form-item">
                <div class="form-label">邮箱地址</div>
                <input 
                    class="form-input" 
                    id="emailInput"
                    placeholder="请输入您的邮箱地址"
                    type="text"
                />
            </div>
            <div class="form-item">
                <div class="form-label">申请理由</div>
                <textarea 
                    class="form-textarea" 
                    id="reasonInput"
                    placeholder="请输入申请理由（50字以内）"
                    maxlength="50"
                ></textarea>
                <div class="word-count"><span id="wordCount">0</span>/50</div>
            </div>
            <div class="modal-btns">
                <div class="modal-btn cancel-btn" id="cancelBtn">取消</div>
                <div class="modal-btn confirm-btn" id="submitBtn">提交</div>
            </div>
        </div>
    </div>

    <script>
        // 缓存和预加载管理器
        class MapCacheManager {
            constructor() {
                this.cache = new Map(); // 图片缓存
                this.loadingQueue = []; // 加载队列
                this.loadingMap = new Map(); // 正在加载的项
                this.maxConcurrent = 2; // 最大并发加载数
                this.totalMaps = 0; // 地图总数
                this.cachedCount = 0; // 已缓存数量
                this.isPreloading = false; // 是否正在预加载
                this.progressCallback = null; // 进度回调
                this.statusCallback = null; // 状态回调
            }
            
            // 初始化
            init(maps, progressCallback, statusCallback) {
                this.totalMaps = maps.length;
                this.progressCallback = progressCallback;
                this.statusCallback = statusCallback;
                this.updateStatus();
            }
            
            // 更新状态
            updateStatus() {
                if (this.statusCallback) {
                    this.statusCallback({
                        cached: this.cachedCount,
                        total: this.totalMaps,
                        loading: this.loadingMap.size,
                        queue: this.loadingQueue.length
                    });
                }
            }
            
            // 检查是否缓存
            isCached(mapId) {
                return this.cache.has(mapId);
            }
            
            // 获取缓存
            getCached(mapId) {
                return this.cache.get(mapId);
            }
            
            // 加载单个地图
            async loadMap(map) {
                if (!map || !map.id) return null;
                
                // 检查缓存
                if (this.isCached(map.id)) {
                    return this.getCached(map.id);
                }
                
                // 检查是否已在加载队列
                if (this.loadingMap.has(map.id)) {
                    return this.loadingMap.get(map.id);
                }
                
                // 生成地图URL
                const mapUrl = this.generateMapUrl(map);
                
                // 创建加载Promise
                const loadPromise = new Promise(async (resolve, reject) => {
                    try {
                        const response = await fetch(mapUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP错误: ${response.status}`);
                        }
                        
                        const blob = await response.blob();
                        const objectUrl = URL.createObjectURL(blob);
                        
                        const cacheItem = {
                            id: map.id,
                            url: objectUrl,
                            title: map.title,
                            timestamp: Date.now()
                        };
                        
                        this.cache.set(map.id, cacheItem);
                        this.cachedCount++;
                        this.updateStatus();
                        
                        console.log(`地图缓存成功: ${map.title}`);
                        resolve(cacheItem);
                    } catch (error) {
                        console.error(`地图加载失败: ${map.title}`, error);
                        reject(error);
                    } finally {
                        this.loadingMap.delete(map.id);
                        this.processQueue(); // 处理队列中的下一项
                    }
                });
                
                // 添加到加载映射
                this.loadingMap.set(map.id, loadPromise);
                
                return loadPromise;
            }
            
            // 添加到预加载队列
            addToQueue(map, priority = 'normal') {
                // 如果已缓存或正在加载，则跳过
                if (this.isCached(map.id) || this.loadingMap.has(map.id)) {
                    return;
                }
                
                // 检查是否已在队列中
                const existingIndex = this.loadingQueue.findIndex(item => item.map.id === map.id);
                if (existingIndex !== -1) {
                    // 如果优先级更高，则提升
                    if (priority === 'high' && this.loadingQueue[existingIndex].priority !== 'high') {
                        this.loadingQueue.splice(existingIndex, 1);
                        this.loadingQueue.unshift({ map, priority });
                    }
                    return;
                }
                
                // 添加到队列
                if (priority === 'high') {
                    this.loadingQueue.unshift({ map, priority });
                } else {
                    this.loadingQueue.push({ map, priority });
                }
                
                // 开始处理队列
                this.processQueue();
            }
            
            // 处理队列
            processQueue() {
                // 检查并发数
                if (this.loadingMap.size >= this.maxConcurrent) {
                    return;
                }
                
                // 没有等待项
                if (this.loadingQueue.length === 0) {
                    return;
                }
                
                // 取出下一个
                const next = this.loadingQueue.shift();
                
                // 开始加载
                this.loadMap(next.map).catch(err => {
                    console.error(`预加载失败: ${next.map.title}`, err);
                });
                
                // 继续处理队列
                if (this.loadingMap.size < this.maxConcurrent) {
                    this.processQueue();
                }
            }
            
            // 开始预加载
            startPreloading(allMaps, currentIndex) {
                if (this.isPreloading) return;
                
                this.isPreloading = true;
                
                // 构建预加载列表 - 优先当前、然后前后2张、然后剩余
                const preloadList = [];
                
                // 1. 当前地图
                const currentMap = allMaps[currentIndex];
                if (currentMap) {
                    preloadList.push({ map: currentMap, priority: 'high' });
                }
                
                // 2. 前后2张
                for (let i = 1; i <= 2; i++) {
                    // 下一张
                    if (currentIndex + i < allMaps.length) {
                        preloadList.push({ map: allMaps[currentIndex + i], priority: 'high' });
                    }
                    
                    // 上一张
                    if (currentIndex - i >= 0) {
                        preloadList.push({ map: allMaps[currentIndex - i], priority: 'high' });
                    }
                }
                
                // 3. 剩余的地图
                for (let i = 0; i < allMaps.length; i++) {
                    if (
                        i !== currentIndex && 
                        i !== currentIndex + 1 && 
                        i !== currentIndex + 2 && 
                        i !== currentIndex - 1 && 
                        i !== currentIndex - 2
                    ) {
                        preloadList.push({ map: allMaps[i], priority: 'normal' });
                    }
                }
                
                // 开始预加载
                console.log(`开始预加载 ${preloadList.length} 张地图`);
                
                // 将列表添加到队列
                for (const item of preloadList) {
                    this.addToQueue(item.map, item.priority);
                }
                
                // 定期更新进度
                const progressInterval = setInterval(() => {
                    const progress = this.cachedCount / this.totalMaps;
                    if (this.progressCallback) {
                        this.progressCallback(progress);
                    }
                    
                    // 如果全部缓存完成或页面已关闭，清除定时器
                    if (this.cachedCount >= this.totalMaps || document.hidden) {
                        clearInterval(progressInterval);
                    }
                }, 300);
            }
            
            // 生成地图URL
            generateMapUrl(map) {
                if (!map || !map.id) {
                    console.error('地图数据无效');
                    return null;
                }
                
                // 生成WMS URL
                const baseUrl = 'http://192.168.50.133:8080/geoserver/hubei/wms';
                const aspectRatio = (map.height && map.width) ? (map.height / map.width) : 0.724;
                const layers = `hubei:${map.id}`;
                
                const params = {
                    SERVICE: 'WMS',
                    VERSION: '1.1.1',
                    REQUEST: 'GetMap',
                    FORMAT: 'image/png',
                    TRANSPARENT: 'true',
                    LAYERS: layers,
                    STYLES: '',
                    SRS: 'EPSG:4326',
                    BBOX: `0,0,1,${aspectRatio}`,
                    WIDTH: map.width ? map.width.toString() : '3000',
                    HEIGHT: map.height ? map.height.toString() : '2000',
                    _t: Date.now() // 防止缓存
                };
                
                const queryParts = [];
                for (const [key, value] of Object.entries(params)) {
                    if (value !== null && value !== undefined) {
                        queryParts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                    }
                }
                
                return `${baseUrl}?${queryParts.join('&')}`;
            }
            
            // 清理缓存
            clearCache() {
                for (const [id, item] of this.cache.entries()) {
                    if (item.url) {
                        URL.revokeObjectURL(item.url);
                    }
                }
                this.cache.clear();
                this.cachedCount = 0;
                this.updateStatus();
            }
        }
        
        // 全局变量
        let viewer;
        let isViewerInitialized = false;
        let webViewData = null;
        let currentMapIndex = 0;
        let allMaps = [];
        let cacheManager = new MapCacheManager();
        let isDebugMode = false; // 调试模式
        
        // 解析URL参数
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            console.log('=== 解析URL参数 ===');
            
            let parsedData = null;
            if (dataParam) {
                try {
                    parsedData = JSON.parse(decodeURIComponent(dataParam));
                    console.log('解析成功，地图数量:', parsedData.allMaps?.length || 0);
                    console.log('当前地图:', parsedData.currentMap?.title);
                    console.log('当前索引:', parsedData.currentIndex);
                } catch (e) {
                    console.error('解析失败:', e);
                }
            }
            
            return parsedData;
        }
        
        // 发送消息到小程序
        function sendMessageToMiniProgram(data) {
            try {
                wx.miniProgram.postMessage({ data });
            } catch (e) {
                console.log('向小程序发送消息失败:', e);
            }
        }
        
        // 发送加载状态
        function sendLoadingStatus(status, message) {
            sendMessageToMiniProgram({
                action: 'loadingStatus',
                status: status,
                message: message
            });
        }
        
        // 更新加载进度
        function updateLoadingProgress(progress) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                const percent = Math.min(Math.round(progress * 100), 100);
                progressBar.style.width = `${percent}%`;
            }
        }
        
        // 更新缓存状态
        function updateCacheStatus(status) {
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                if (isDebugMode) {
                    statusBar.style.display = 'block';
                    statusBar.textContent = `缓存: ${status.cached}/${status.total}, 加载中: ${status.loading}, 队列: ${status.queue}`;
                } else {
                    statusBar.style.display = 'none';
                }
            }
        }
        
        // 获取当前地图数据
        function getCurrentMapData() {
            return allMaps[currentMapIndex];
        }
        
        // 更新UI显示
        function updateUI() {
            const currentMap = getCurrentMapData();
            if (!currentMap) return;
            
            console.log(`更新UI: ${currentMap.title} (${currentMapIndex + 1}/${allMaps.length})`);
            
            // 更新标题
            document.getElementById('mapTitle').textContent = currentMap.title;
            
            // 更新计数器
            document.getElementById('mapCounter').textContent = `${currentMapIndex + 1} / ${allMaps.length}`;
            
            // 更新按钮状态
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentMapIndex === 0;
            nextBtn.disabled = currentMapIndex === allMaps.length - 1;
            
            console.log('UI更新完成');
        }
        
        // 加载当前地图
        async function loadCurrentMap() {
            const currentMap = getCurrentMapData();
            if (!currentMap) {
                console.error('当前地图数据无效');
                return;
            }
            
            console.log(`=== 加载地图: ${currentMap.title} ===`);
            
            const loadStartTime = Date.now();
            
            // 显示加载状态
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').textContent = '地图加载中...';
            sendLoadingStatus('start', '地图加载中...');
            
            // 更新UI
            updateUI();
            
            try {
                // 加载当前地图（会自动使用缓存）
                const cached = await cacheManager.loadMap(currentMap);
                
                if (!cached || !cached.url) {
                    throw new Error('地图加载失败');
                }
                
                const mapUrl = cached.url;
                
                // 加载到OpenSeadragon
                if (!isViewerInitialized) {
                    console.log('初始化OpenSeadragon查看器');
                    viewer = OpenSeadragon({
                        id: "map-container",
                        prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/images/",
                        tileSources: {
                            type: 'image',
                            url: mapUrl,
                            buildPyramid: false
                        },
                        immediateRender: false,
                        blendTime: 0.1,
                        showNavigator: false
                    });
                    
                    isViewerInitialized = true;
                    
                    viewer.addHandler('open', function() {
                        const loadTime = Date.now() - loadStartTime;
                        console.log(`地图加载完成，耗时: ${loadTime}ms`);
                        document.getElementById('loading').style.display = 'none';
                        sendLoadingStatus('complete');
                        
                        // 如果是首次加载，开始预加载其他地图
                        startPreloading();
                    });
                    
                } else {
                    console.log('切换到新地图');
                    viewer.open({
                        type: 'image',
                        url: mapUrl,
                        buildPyramid: false
                    });
                    
                    viewer.addOnceHandler('open', function() {
                        const loadTime = Date.now() - loadStartTime;
                        console.log(`地图切换完成，耗时: ${loadTime}ms`);
                        document.getElementById('loading').style.display = 'none';
                        sendLoadingStatus('complete');
                    });
                }
                
            } catch (error) {
                console.error('地图加载失败:', error);
                document.getElementById('loading-text').textContent = '地图加载失败，请重试';
                sendLoadingStatus('error', '地图加载失败，请重试');
            }
        }
        
        // 开始预加载
        function startPreloading() {
            console.log('开始预加载流程');
            cacheManager.startPreloading(allMaps, currentMapIndex);
        }
        
        // 切换地图
        function switchMap(direction) {
            console.log(`=== 切换地图: ${direction} ===`);
            console.log(`当前索引: ${currentMapIndex}`);
            
            let newIndex = currentMapIndex;
            
            if (direction === 'next' && currentMapIndex < allMaps.length - 1) {
                newIndex = currentMapIndex + 1;
            } else if (direction === 'prev' && currentMapIndex > 0) {
                newIndex = currentMapIndex - 1;
            } else {
                console.log('无法切换到指定方向');
                return;
            }
            
            currentMapIndex = newIndex;
            
            console.log(`新索引: ${currentMapIndex}`);
            console.log(`新地图: ${getCurrentMapData().title}`);
            
            // 加载新地图
            loadCurrentMap();
        }
        
        // 显示下载对话框
        function showDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
            document.getElementById('emailInput').value = '';
            document.getElementById('reasonInput').value = '';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // 隐藏下载对话框
        function hideDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        // 提交下载申请
        function submitDownloadRequest() {
            const email = document.getElementById('emailInput').value.trim();
            const reason = document.getElementById('reasonInput').value.trim();
            
            if (!email || !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            if (!reason) {
                alert('请输入申请理由');
                return;
            }
            
            console.log('提交下载申请:', {
                mapId: getCurrentMapData().id,
                email: email,
                reason: reason
            });
            
            sendMessageToMiniProgram({
                action: 'downloadRequest',
                email: email,
                reason: reason,
                mapId: getCurrentMapData().id
            });
            
            hideDownloadModal();
        }
        
        // 查看详情
        function viewDetail() {
            console.log('查看详情:', getCurrentMapData().title);
            
            sendMessageToMiniProgram({
                action: 'viewDetail',
                mapId: getCurrentMapData().id
            });
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 页面初始化 ===');
            
            // 初始化UI
            updateLoadingProgress(0);
            
            // 发送加载状态
            sendLoadingStatus('start', '正在解析数据...');
            
            // 解析数据
            webViewData = getUrlParams();
            
            if (!webViewData || !webViewData.allMaps || webViewData.allMaps.length === 0) {
                console.error('没有有效的地图数据');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loading-text').textContent = '无法加载地图数据';
                sendLoadingStatus('error', '无法加载地图数据');
                return;
            }
            
            // 初始化全局变量
            allMaps = webViewData.allMaps;
            currentMapIndex = webViewData.currentIndex || 0;
            
            console.log(`初始化完成 - 地图总数: ${allMaps.length}, 当前索引: ${currentMapIndex}`);
            
            // 初始化缓存管理器
            cacheManager.init(allMaps, updateLoadingProgress, updateCacheStatus);
            
            // 加载初始地图
            loadCurrentMap();
            
            // 绑定事件
            document.getElementById('prevBtn').addEventListener('click', () => switchMap('prev'));
            document.getElementById('nextBtn').addEventListener('click', () => switchMap('next'));
            document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
            document.getElementById('cancelBtn').addEventListener('click', hideDownloadModal);
            document.getElementById('submitBtn').addEventListener('click', submitDownloadRequest);
            document.getElementById('map-container').addEventListener('dblclick', viewDetail);
            
            // 调试模式切换
            document.getElementById('status-bar').addEventListener('click', function() {
                isDebugMode = !isDebugMode;
                updateCacheStatus(cacheManager.cachedCount, cacheManager.totalMaps);
            });
            
            // 字数统计
            document.getElementById('reasonInput').addEventListener('input', function() {
                document.getElementById('wordCount').textContent = this.value.length;
            });
            
            console.log('事件绑定完成');
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            console.log('页面卸载，清理资源');
            cacheManager.clearCache();
        });
    </script>
</body>
</html>