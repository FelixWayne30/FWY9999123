<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>湖北地图查看器</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background: #f8f8f8;
        }
        /* 不需要重置按钮，因为在小程序端已有 */
    </style>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
   <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
</head>
<body>
    <div id="map"></div>

    <script>
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const layerName = urlParams.get('layer') || 'hubei:1-1春夏秋冬0331';
        const serverUrl = urlParams.get('server') || 'http://192.168.50.133:8080/geoserver/hubei/wms';
        
        // 创建WMS图层
        const wmsLayer = new ol.layer.Image({
            source: new ol.source.ImageWMS({
                url: serverUrl,
                params: {
                    'LAYERS': layerName,
                    'FORMAT': 'image/png',
                    'VERSION': '1.1.0'
                },
                ratio: 1,
                serverType: 'geoserver'
            })
        });

        // 创建地图视图
        const view = new ol.View({
            center: [0, 0],
            zoom: 2,
            projection: 'EPSG:4326'
        });

        // 创建地图
        const map = new ol.Map({
            target: 'map',
            layers: [wmsLayer],
            view: view
        });

        // 初始化时自动缩放到图层范围
        function fitToLayer() {
            fetch(serverUrl + '?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities')
                .then(response => response.text())
                .then(text => {
                    const parser = new ol.format.WMSCapabilities();
                    const capabilities = parser.read(text);
                    
                    // 尝试查找图层边界
                    const layers = capabilities.Capability.Layer.Layer;
                    let targetLayer;
                    
                    for (let layer of layers) {
                        if (layer.Name === layerName) {
                            targetLayer = layer;
                            break;
                        }
                    }
                    
                    if (targetLayer && targetLayer.BoundingBox) {
                        const bbox = targetLayer.BoundingBox[0].extent;
                        const extent = [bbox[0], bbox[1], bbox[2], bbox[3]];
                        view.fit(extent, { padding: [20, 20, 20, 20], maxZoom: 19 });
                    } else {
                        // 如果没有找到边界，使用湖北省的大致范围
                        view.fit([108.3838, 29.0500, 116.1221, 33.2698], { padding: [20, 20, 20, 20] });
                    }
                    
                    // 通知小程序地图已加载完成
                    notifyAppMapReady();
                })
                .catch(error => {
                    console.error('获取图层信息出错:', error);
                    // 使用湖北省的大致范围作为后备
                    view.fit([108.3838, 29.0500, 116.1221, 33.2698], { padding: [20, 20, 20, 20] });
                    notifyAppMapReady();
                });
        }
        
        // 通知小程序地图已准备好
        function notifyAppMapReady() {
            if (window.uni) {
                window.uni.postMessage({
                    data: {
                        action: 'mapReady',
                        layerName: layerName
                    }
                });
            }
        }
        
        // 监听来自小程序的消息
        window.addEventListener('message', function(e) {
            let message;
            try {
                message = e.data;
            } catch (error) {
                console.error('解析消息失败:', error);
                return;
            }
            
            // 如果是重置命令
            if (message === 'reset' || (message.data && message.data === 'reset')) {
                fitToLayer();
            }
        });
        
        // 页面加载完成后适应图层范围
        window.onload = fitToLayer;
    </script>
</body>
</html>
