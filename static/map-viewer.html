<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>湖北省地图浏览</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, 
                Segoe UI, Arial, Roboto, 'PingFang SC', 'miui', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
        }
        #map-container {
            height: calc(100% - 130px);
            width: 100%;
            background-color: #f3f3f3;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            height: 45px;
        }
        .tool-btn {
            width: 80px;
            height: 35px;
            line-height: 35px;
            font-size: 14px;
            border-radius: 5px;
            color: #2E8B57;
            border: 1px solid #2E8B57;
            background-color: #FFFFFF;
            text-align: center;
            cursor: pointer;
        }
        .tool-btn:disabled {
            color: #CCCCCC;
            border-color: #EEEEEE;
            background-color: #F8F8F8;
            cursor: not-allowed;
        }
        .map-title {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .map-counter {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666666;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .download-bar {
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            display: flex;
            justify-content: center;
            height: 40px;
            position: relative;
        }
        .download-btn {
            width: 100%;
            height: 40px;
            line-height: 40px;
            font-size: 15px;
            color: #FFFFFF;
            background-color: #2E8B57;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 130px);
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-text {
            font-size: 16px;
            color: #2E8B57;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .preload-info {
            position: absolute;
            bottom: 160px;
            left: 20px;
            background-color: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            z-index: 500;
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            width: 80%;
            background-color: #FFFFFF;
            border-radius: 15px;
            padding: 20px 15px;
            max-width: 500px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-label {
            font-size: 15px;
            color: #666666;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            height: 40px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            height: 100px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .word-count {
            text-align: right;
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
        }
        .modal-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-btn {
            width: 45%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #F5F5F5;
            color: #666666;
        }
        .confirm-btn {
            background-color: #2E8B57;
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="map-container"></div>
    
    <!-- 加载指示器 -->
    <div id="loading" class="loading">
        <div class="loading-text">地图加载中...</div>
    </div>
    
    <!-- 预加载信息提示 -->
    <div id="preload-info" class="preload-info">正在预加载图片...</div>
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button class="tool-btn" id="prevBtn" disabled>上一张</button>
        <div class="map-title" id="mapTitle">加载中...</div>
        <button class="tool-btn" id="nextBtn" disabled>下一张</button>
    </div>
    
    <!-- 下载栏 -->
    <div class="download-bar">
        <div class="map-counter" id="mapCounter">1 / 1</div>
        <div class="download-btn" id="downloadBtn">申请下载此图</div>
    </div>
    
    <!-- 下载对话框 -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">下载申请</div>
            <div class="form-item">
                <div class="form-label">邮箱地址</div>
                <input 
                    class="form-input" 
                    id="emailInput"
                    placeholder="请输入您的邮箱地址"
                    type="text"
                />
            </div>
            <div class="form-item">
                <div class="form-label">申请理由</div>
                <textarea 
                    class="form-textarea" 
                    id="reasonInput"
                    placeholder="请输入申请理由（50字以内）"
                    maxlength="50"
                ></textarea>
                <div class="word-count"><span id="wordCount">0</span>/50</div>
            </div>
            <div class="modal-btns">
                <div class="modal-btn cancel-btn" id="cancelBtn">取消</div>
                <div class="modal-btn confirm-btn" id="submitBtn">提交</div>
            </div>
        </div>
    </div>

    <script>
        // 解析URL参数获取地图数据
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            console.log('=== 开始解析URL参数 ===');
            console.log('data参数:', dataParam);
            
            let webViewData = null;
            if (dataParam) {
                try {
                    webViewData = JSON.parse(decodeURIComponent(dataParam));
                    console.log('解析后的WebView数据:', webViewData);
                } catch (e) {
                    console.error('解析WebView数据失败:', e);
                }
            }
            
            return webViewData;
        }
        
        // 根据地图数据生成WMS完整图片URL
        function generateFullMapUrl(mapData) {
            if (!mapData || !mapData.id) {
                console.error('地图数据无效');
                return null;
            }
            
            console.log('=== 生成完整地图URL ===');
            console.log('地图ID:', mapData.id);
            console.log('地图尺寸:', mapData.width, 'x', mapData.height);
            
            const baseUrl = 'http://192.168.50.133:8080/geoserver/hubei/wms';
            const aspectRatio = (mapData.height && mapData.width) ? (mapData.height / mapData.width) : 0.724;
            const layers = `hubei:${mapData.id}`;
            
            // 构建查询参数
            const params = {
                SERVICE: 'WMS',
                VERSION: '1.1.1',
                REQUEST: 'GetMap',
                FORMAT: 'image/png',
                TRANSPARENT: 'true',
                LAYERS: layers,
                STYLES: '',
                SRS: 'EPSG:4326',
                BBOX: `0,0,1,${aspectRatio}`,
                WIDTH: mapData.width.toString(),
                HEIGHT: mapData.height.toString(),
            };
            
            // 手动构建查询字符串
            const queryParts = [];
            for (const [key, value] of Object.entries(params)) {
                if (value !== null && value !== undefined) {
                    queryParts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                }
            }
            const queryString = queryParts.join('&');
            
            const fullUrl = `${baseUrl}?${queryString}`;
            console.log('生成的完整地图URL:', fullUrl);
            
            return fullUrl;
        }
        
        // 预加载管理器
        class PreloadManager {
            constructor() {
                this.imageCache = {};
                this.loadingImages = {};
                this.preloadStatus = {};
            }
            
            preload(url) {
                if (this.imageCache[url]) {
                    return Promise.resolve(this.imageCache[url]);
                }
                
                if (this.loadingImages[url]) {
                    return this.loadingImages[url];
                }
                
                this.preloadStatus[url] = 0;
                
                const loadPromise = new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'blob';
                    
                    xhr.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            this.preloadStatus[url] = percentComplete;
                            this.updatePreloadInfo();
                        }
                    };
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const blob = xhr.response;
                            const imageUrl = URL.createObjectURL(blob);
                            
                            const img = new Image();
                            img.onload = () => {
                                this.imageCache[url] = {
                                    blob: blob,
                                    url: imageUrl,
                                    image: img
                                };
                                delete this.loadingImages[url];
                                this.preloadStatus[url] = 100;
                                this.updatePreloadInfo();
                                resolve(this.imageCache[url]);
                            };
                            
                            img.onerror = (error) => {
                                delete this.loadingImages[url];
                                reject(error);
                            };
                            
                            img.src = imageUrl;
                        } else {
                            delete this.loadingImages[url];
                            reject(new Error(`加载图片失败: ${xhr.status}`));
                        }
                    };
                    
                    xhr.onerror = (error) => {
                        delete this.loadingImages[url];
                        reject(error);
                    };
                    
                    xhr.send();
                });
                
                this.loadingImages[url] = loadPromise;
                return loadPromise;
            }
            
            getCachedImage(url) {
                return this.imageCache[url] || null;
            }
            
            updatePreloadInfo() {
                const preloadInfo = document.getElementById('preload-info');
                let isPreloading = false;
                let statusText = '';
                
                for (const url in this.loadingImages) {
                    isPreloading = true;
                    const status = this.preloadStatus[url] || 0;
                    statusText = `预加载中：${status}%`;
                    break;
                }
                
                if (isPreloading) {
                    preloadInfo.textContent = statusText;
                    preloadInfo.style.display = 'block';
                } else {
                    preloadInfo.style.display = 'none';
                }
            }
            
            clearCache() {
                for (const url in this.imageCache) {
                    if (this.imageCache[url].url) {
                        URL.revokeObjectURL(this.imageCache[url].url);
                    }
                }
                
                this.imageCache = {};
                this.preloadStatus = {};
            }
        }
        
        // 全局变量
        const preloadManager = new PreloadManager();
        let viewer;
        let isViewerInitialized = false;
        let webViewData = null;
        let currentMapIndex = 0;
        let allMaps = [];
        
        // 初始化查看器
        function initViewer() {
            console.log('=== 初始化查看器 ===');
            
            const currentMap = allMaps[currentMapIndex];
            console.log('当前地图数据:', currentMap);
            
            // 更新UI
            updateUI();
            
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            
            // 生成地图URL
            const mapUrl = generateFullMapUrl(currentMap);
            if (!mapUrl) {
                console.error('无法生成地图URL');
                return;
            }
            
            // 检查缓存
            const cachedImage = preloadManager.getCachedImage(mapUrl);
            
            // 创建OpenSeadragon查看器
            viewer = OpenSeadragon({
                id: "map-container",
                prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/images/",
                tileSources: {
                    type: 'image',
                    url: cachedImage ? cachedImage.url : mapUrl,
                    buildPyramid: false
                },
                immediateRender: false,
                blendTime: 0.1,
                showNavigator: false
            });
            
            isViewerInitialized = true;
            
            viewer.addHandler('open', function() {
                document.getElementById('loading').style.display = 'none';
                console.log('地图加载完成');
            });
        }
        
        // 切换地图
        function switchMap(direction) {
            console.log('=== 切换地图 ===');
            console.log('方向:', direction);
            console.log('当前索引:', currentMapIndex);
            
            let newIndex = currentMapIndex;
            
            if (direction === 'next' && currentMapIndex < allMaps.length - 1) {
                newIndex = currentMapIndex + 1;
            } else if (direction === 'prev' && currentMapIndex > 0) {
                newIndex = currentMapIndex - 1;
            } else {
                console.log('无法切换到指定方向');
                return;
            }
            
            currentMapIndex = newIndex;
            console.log('新索引:', currentMapIndex);
            
            // 通知小程序切换地图
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'switchMap',
                        direction: direction,
                        newIndex: currentMapIndex,
                        newMapId: allMaps[currentMapIndex].id
                    }
                });
            } catch (e) {
                console.error('向小程序发送切换消息失败:', e);
            }
            
            // 加载新地图
            loadCurrentMap();
        }
        
        // 加载当前地图
        function loadCurrentMap() {
            console.log('=== 加载当前地图 ===');
            
            const currentMap = allMaps[currentMapIndex];
            console.log('当前地图:', currentMap);
            
            // 更新UI
            updateUI();
            
            // 生成地图URL
            const mapUrl = generateFullMapUrl(currentMap);
            if (!mapUrl) {
                console.error('无法生成地图URL');
                return;
            }
            
            // 检查缓存
            const cachedImage = preloadManager.getCachedImage(mapUrl);
            
            if (cachedImage) {
                console.log('使用缓存加载图片');
                viewer.open({
                    type: 'image',
                    url: cachedImage.url,
                    buildPyramid: false
                });
            } else {
                console.log('开始预加载图片');
                document.getElementById('loading').style.display = 'flex';
                
                preloadManager.preload(mapUrl)
                    .then((cached) => {
                        document.getElementById('loading').style.display = 'none';
                        viewer.open({
                            type: 'image',
                            url: cached.url,
                            buildPyramid: false
                        });
                        console.log('图片加载完成');
                    })
                    .catch(error => {
                        console.error(`加载图片失败: ${error}`);
                        document.getElementById('loading').style.display = 'none';
                        alert('加载图片失败，请重试');
                    });
            }
        }
        
        // 更新UI状态
        function updateUI() {
            const currentMap = allMaps[currentMapIndex];
            
            // 更新标题
            document.getElementById('mapTitle').textContent = currentMap.title;
            
            // 更新计数器
            document.getElementById('mapCounter').textContent = `${currentMapIndex + 1} / ${allMaps.length}`;
            
            // 更新按钮状态
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentMapIndex === 0;
            nextBtn.disabled = currentMapIndex === allMaps.length - 1;
            
            console.log('UI更新完成');
        }
        
        // 显示下载对话框
        function showDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
            document.getElementById('emailInput').value = '';
            document.getElementById('reasonInput').value = '';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // 隐藏下载对话框
        function hideDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        // 提交下载请求
        function submitDownloadRequest() {
            const email = document.getElementById('emailInput').value.trim();
            const reason = document.getElementById('reasonInput').value.trim();
            
            if (!email || !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            if (!reason) {
                alert('请输入申请理由');
                return;
            }
            
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'downloadRequest',
                        email: email,
                        reason: reason,
                        mapId: allMaps[currentMapIndex].id
                    }
                });
                
                hideDownloadModal();
                alert('申请已提交，我们会尽快处理！');
            } catch (e) {
                console.error('向小程序发送消息失败:', e);
                hideDownloadModal();
                alert('申请已提交，我们会尽快处理！');
            }
        }
        
        // 跳转到详情页
        function viewDetail() {
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'viewDetail',
                        mapId: allMaps[currentMapIndex].id
                    }
                });
            } catch (e) {
                console.error('向小程序发送消息失败:', e);
            }
        }
        
        // 页面加载完成时执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 页面DOM加载完成 ===');
            
            // 解析URL参数
            webViewData = getUrlParams();
            
            if (!webViewData || !webViewData.allMaps || webViewData.allMaps.length === 0) {
                console.error('没有有效的地图数据');
                document.getElementById('loading').style.display = 'none';
                alert('无法加载地图数据');
                return;
            }
            
            // 初始化全局变量
            allMaps = webViewData.allMaps;
            currentMapIndex = webViewData.currentIndex || 0;
            
            console.log('所有地图:', allMaps);
            console.log('当前索引:', currentMapIndex);
            
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            
            // 预加载当前地图
            const currentMap = allMaps[currentMapIndex];
            const mapUrl = generateFullMapUrl(currentMap);
            
            if (mapUrl) {
                preloadManager.preload(mapUrl)
                    .then(() => {
                        console.log('地图预加载完成');
                        initViewer();
                    })
                    .catch(error => {
                        console.error('地图预加载失败:', error);
                        initViewer();
                    });
            } else {
                console.error('无法生成地图URL');
                document.getElementById('loading').style.display = 'none';
                alert('无法生成地图URL');
            }
            
            // 添加事件监听器
            document.getElementById('prevBtn').addEventListener('click', () => switchMap('prev'));
            document.getElementById('nextBtn').addEventListener('click', () => switchMap('next'));
            document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
            document.getElementById('cancelBtn').addEventListener('click', hideDownloadModal);
            document.getElementById('submitBtn').addEventListener('click', submitDownloadRequest);
            
            // 双击查看详情
            document.getElementById('map-container').addEventListener('dblclick', viewDetail);
            
            // 字数统计
            document.getElementById('reasonInput').addEventListener('input', function() {
                document.getElementById('wordCount').textContent = this.value.length;
            });
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            preloadManager.clearCache();
        });
    </script>
</body>
</html>