<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>湖北省地图浏览</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, 
                Segoe UI, Arial, Roboto, 'PingFang SC', 'miui', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
        }
        #map-container {
            height: calc(100% - 130px);
            width: 100%;
            background-color: #f3f3f3;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            height: 45px;
        }
        .tool-btn {
            width: 80px;
            height: 35px;
            line-height: 35px;
            font-size: 14px;
            border-radius: 5px;
            color: #2E8B57;
            border: 1px solid #2E8B57;
            background-color: #FFFFFF;
            text-align: center;
            cursor: pointer;
        }
        .tool-btn:disabled {
            color: #CCCCCC;
            border-color: #EEEEEE;
            background-color: #F8F8F8;
            cursor: not-allowed;
        }
        .map-title {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .download-bar {
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-top: 1px solid #EEEEEE;
            display: flex;
            justify-content: center;
            height: 40px;
        }
        .download-btn {
            width: 100%;
            height: 40px;
            line-height: 40px;
            font-size: 15px;
            color: #FFFFFF;
            background-color: #2E8B57;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 130px);
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-text {
            font-size: 16px;
            color: #2E8B57;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .preload-info {
            position: absolute;
            bottom: 160px;
            left: 20px;
            background-color: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            z-index: 500;
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            width: 80%;
            background-color: #FFFFFF;
            border-radius: 15px;
            padding: 20px 15px;
            max-width: 500px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-label {
            font-size: 15px;
            color: #666666;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            height: 40px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            height: 100px;
            border: 1px solid #EEEEEE;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .word-count {
            text-align: right;
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
        }
        .modal-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-btn {
            width: 45%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #F5F5F5;
            color: #666666;
        }
        .confirm-btn {
            background-color: #2E8B57;
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="map-container"></div>
    
    <!-- 加载指示器 -->
    <div id="loading" class="loading">
        <div class="loading-text">地图加载中...</div>
    </div>
    
    <!-- 预加载信息提示 -->
    <div id="preload-info" class="preload-info">正在预加载图片...</div>
    
    <!-- 工具栏 -->
    <div class="toolbar">
        <button class="tool-btn" id="prevBtn" style="display:none;" disabled>上一张</button>
        <div class="map-title" id="mapTitle">加载中...</div>
        <button class="tool-btn" id="nextBtn" style="display:none;">下一张</button>
    </div>
    
    <!-- 下载栏 -->
    <div class="download-bar">
        <div class="download-btn" id="downloadBtn">申请下载此图</div>
    </div>
    
    <!-- 下载对话框 -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">下载申请</div>
            <div class="form-item">
                <div class="form-label">邮箱地址</div>
                <input 
                    class="form-input" 
                    id="emailInput"
                    placeholder="请输入您的邮箱地址"
                    type="text"
                />
            </div>
            <div class="form-item">
                <div class="form-label">申请理由</div>
                <textarea 
                    class="form-textarea" 
                    id="reasonInput"
                    placeholder="请输入申请理由（50字以内）"
                    maxlength="50"
                ></textarea>
                <div class="word-count"><span id="wordCount">0</span>/50</div>
            </div>
            <div class="modal-btns">
                <div class="modal-btn cancel-btn" id="cancelBtn">取消</div>
                <div class="modal-btn confirm-btn" id="submitBtn">提交</div>
            </div>
        </div>
    </div>

    <script>
        // 解析URL参数获取地图数据
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const mapDataParam = urlParams.get('mapData');
            const topicId = urlParams.get('topicId');
            
            console.log('=== 开始解析URL参数 ===');
            console.log('mapData参数:', mapDataParam);
            console.log('topicId参数:', topicId);
            
            let mapData = null;
            if (mapDataParam) {
                try {
                    mapData = JSON.parse(decodeURIComponent(mapDataParam));
                    console.log('解析后的地图数据:', mapData);
                } catch (e) {
                    console.error('解析地图数据失败:', e);
                }
            }
            
            return { mapData, topicId };
        }
        
        // 根据地图数据生成WMS完整图片URL
        function generateFullMapUrl(mapData) {
            if (!mapData || !mapData.map_id) {
                console.error('地图数据无效');
                return null;
            }
            
            console.log('=== 生成完整地图URL ===');
            console.log('地图ID:', mapData.map_id);
            console.log('地图尺寸:', mapData.width, 'x', mapData.height);
            
            const baseUrl = 'http://192.168.50.133:8080/geoserver/hubei/wms';
            const aspectRatio = (mapData.height && mapData.width) ? (mapData.height / mapData.width) : 0.724;
            const layers = `hubei:${mapData.map_id}`;
            
            // 构建查询参数
            const params = {
                SERVICE: 'WMS',
                VERSION: '1.1.1',
                REQUEST: 'GetMap',
                FORMAT: 'image/png',
                TRANSPARENT: 'true',
                LAYERS: layers,
                STYLES: '',
                SRS: 'EPSG:4326',
                BBOX: `0,0,1,${aspectRatio}`,
                WIDTH: mapData.width.toString(),
                HEIGHT: mapData.height.toString(),
            };
            
            // 手动构建查询字符串
            const queryParts = [];
            for (const [key, value] of Object.entries(params)) {
                if (value !== null && value !== undefined) {
                    queryParts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                }
            }
            const queryString = queryParts.join('&');
            
            const fullUrl = `${baseUrl}?${queryString}`;
            console.log('生成的完整地图URL:', fullUrl);
            
            return fullUrl;
        }
        
        // 解析URL参数获取数据
        const { mapData, topicId } = getUrlParams();
        
        // 初始化地图数据
        let maps = [];
        
        if (mapData) {
            // 使用真实地图数据
            maps = [{
                id: mapData.map_id,
                title: mapData.title,
                url: generateFullMapUrl(mapData)
            }];
            console.log('初始化地图数据完成:', maps);
        } else {
            console.error('未获取到地图数据，使用默认数据');
        }
        
        // 预加载管理器
        class PreloadManager {
            constructor() {
                // 图片缓存
                this.imageCache = {};
                // 正在加载的图片
                this.loadingImages = {};
                // 预加载状态
                this.preloadStatus = {};
            }
            
            // 预加载图片
            preload(url) {
                // 如果已经缓存，直接返回
                if (this.imageCache[url]) {
                    return Promise.resolve(this.imageCache[url]);
                }
                
                // 如果正在加载，返回现有的Promise
                if (this.loadingImages[url]) {
                    return this.loadingImages[url];
                }
                
                // 创建新的加载Promise
                this.preloadStatus[url] = 0; // 0%进度
                
                const loadPromise = new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'blob';
                    
                    // 进度监听
                    xhr.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            this.preloadStatus[url] = percentComplete;
                            this.updatePreloadInfo();
                        }
                    };
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const blob = xhr.response;
                            const imageUrl = URL.createObjectURL(blob);
                            
                            // 创建Image对象并加载
                            const img = new Image();
                            img.onload = () => {
                                this.imageCache[url] = {
                                    blob: blob,
                                    url: imageUrl,
                                    image: img
                                };
                                delete this.loadingImages[url];
                                this.preloadStatus[url] = 100;
                                this.updatePreloadInfo();
                                resolve(this.imageCache[url]);
                            };
                            
                            img.onerror = (error) => {
                                delete this.loadingImages[url];
                                reject(error);
                            };
                            
                            img.src = imageUrl;
                        } else {
                            delete this.loadingImages[url];
                            reject(new Error(`加载图片失败: ${xhr.status}`));
                        }
                    };
                    
                    xhr.onerror = (error) => {
                        delete this.loadingImages[url];
                        reject(error);
                    };
                    
                    xhr.send();
                });
                
                this.loadingImages[url] = loadPromise;
                return loadPromise;
            }
            
            // 获取缓存的图片
            getCachedImage(url) {
                return this.imageCache[url] || null;
            }
            
            // 更新预加载信息显示
            updatePreloadInfo() {
                const preloadInfo = document.getElementById('preload-info');
                let isPreloading = false;
                let statusText = '';
                
                // 检查是否有正在加载的图片
                for (const url in this.loadingImages) {
                    isPreloading = true;
                    const status = this.preloadStatus[url] || 0;
                    statusText = `预加载中：${status}%`;
                    break; // 只显示第一个
                }
                
                if (isPreloading) {
                    preloadInfo.textContent = statusText;
                    preloadInfo.style.display = 'block';
                } else {
                    preloadInfo.style.display = 'none';
                }
            }
            
            // 清除缓存
            clearCache() {
                // 释放Blob URL
                for (const url in this.imageCache) {
                    if (this.imageCache[url].url) {
                        URL.revokeObjectURL(this.imageCache[url].url);
                    }
                }
                
                this.imageCache = {};
                this.preloadStatus = {};
            }
        }
        
        // 创建预加载管理器实例
        const preloadManager = new PreloadManager();
        
        // 状态变量
        let viewer;
        let isViewerInitialized = false;
        
        // 初始化查看器
        function initViewer() {
            console.log('=== 初始化查看器 ===');
            console.log('当前地图数据:', maps[0]);
            
            // 更新标题
            document.getElementById('mapTitle').textContent = maps[0].title;
            
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            
            // 如果当前图片已预加载，使用缓存
            const currentMapUrl = maps[0].url;
            const cachedImage = preloadManager.getCachedImage(currentMapUrl);
            
            // 创建OpenSeadragon查看器
            viewer = OpenSeadragon({
                id: "map-container",
                prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/images/",
                // 使用缓存的图片URL或原始URL
                tileSources: {
                    type: 'image',
                    url: cachedImage ? cachedImage.url : currentMapUrl,
                    buildPyramid: false
                },
                immediateRender: false,
                blendTime: 0.1,
                showNavigator: false
            });
            
            // 查看器初始化完成
            isViewerInitialized = true;
            
            // 监听图片加载完成事件
            viewer.addHandler('open', function() {
                // 隐藏加载指示器
                document.getElementById('loading').style.display = 'none';
                console.log('地图加载完成');
            });
            
            // 更新UI状态（隐藏切换按钮，因为只有一张图）
            updateUI();
        }
        
        // 加载图片
        function loadImage() {
            console.log('=== 加载图片 ===');
            
            // 更新标题
            document.getElementById('mapTitle').textContent = maps[0].title;
            
            // 获取图片URL
            const imageUrl = maps[0].url;
            
            // 检查是否已缓存
            const cachedImage = preloadManager.getCachedImage(imageUrl);
            
            // 如果图片已缓存，直接显示
            if (cachedImage) {
                console.log(`使用缓存加载图片: ${maps[0].title}`);
                viewer.open({
                    type: 'image',
                    url: cachedImage.url,
                    buildPyramid: false
                });
            } else {
                // 显示加载指示器
                document.getElementById('loading').style.display = 'flex';
                
                // 加载图片
                preloadManager.preload(imageUrl)
                    .then((cached) => {
                        // 隐藏加载指示器
                        document.getElementById('loading').style.display = 'none';
                        
                        // 加载图片到查看器
                        viewer.open({
                            type: 'image',
                            url: cached.url,
                            buildPyramid: false
                        });
                        
                        console.log('图片加载完成');
                    })
                    .catch(error => {
                        console.error(`加载图片失败: ${error}`);
                        document.getElementById('loading').style.display = 'none';
                        alert('加载图片失败，请重试');
                    });
            }
            
            // 更新UI
            updateUI();
        }
        
        // 更新UI状态（隐藏切换按钮）
        function updateUI() {
            // 隐藏上一张和下一张按钮，因为只有一张图
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
        }
        
        // 显示下载对话框
        function showDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
            document.getElementById('emailInput').value = '';
            document.getElementById('reasonInput').value = '';
            document.getElementById('wordCount').textContent = '0';
        }
        
        // 隐藏下载对话框
        function hideDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        // 提交下载请求
        function submitDownloadRequest() {
            const email = document.getElementById('emailInput').value.trim();
            const reason = document.getElementById('reasonInput').value.trim();
            
            // 验证邮箱
            if (!email || !/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            // 验证理由
            if (!reason) {
                alert('请输入申请理由');
                return;
            }
            
            // 发送消息给小程序
            try {
                wx.miniProgram.postMessage({
                    data: {
                        action: 'downloadRequest',
                        email: email,
                        reason: reason,
                        mapId: maps[0].id
                    }
                });
                
                hideDownloadModal();
                alert('申请已提交，我们会尽快处理！');
            } catch (e) {
                console.error('向小程序发送消息失败:', e);
                hideDownloadModal();
                alert('申请已提交，我们会尽快处理！');
            }
        }
        
        // 页面加载完成时执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 页面DOM加载完成 ===');
            console.log('地图数组:', maps);
            
            if (maps.length === 0 || !maps[0].url) {
                console.error('没有有效的地图数据');
                document.getElementById('loading').style.display = 'none';
                alert('无法加载地图数据');
                return;
            }
            
            // 预加载当前图片，完成后初始化查看器
            const currentMapUrl = maps[0].url;
            
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            
            preloadManager.preload(currentMapUrl)
                .then(() => {
                    console.log(`地图预加载完成: ${maps[0].title}`);
                    // 初始化查看器
                    initViewer();
                })
                .catch(error => {
                    console.error(`地图预加载失败: ${error}`);
                    // 即使预加载失败也初始化查看器
                    initViewer();
                });
            
            // 添加事件监听器
            document.getElementById('downloadBtn').addEventListener('click', showDownloadModal);
            document.getElementById('cancelBtn').addEventListener('click', hideDownloadModal);
            document.getElementById('submitBtn').addEventListener('click', submitDownloadRequest);
            
            // 字数统计
            document.getElementById('reasonInput').addEventListener('input', function() {
                document.getElementById('wordCount').textContent = this.value.length;
            });
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            // 清除图片缓存，释放内存
            preloadManager.clearCache();
        });
    </script>
</body>
</html>